#!/bin/bash
set -e

################################################################################
# Piston Control System - Complete Security Initialization Script
################################################################################

RED='\033[0;31m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
NC='\033[0m'

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Organization info for certificates
COUNTRY="TN"
STATE="Sfax"
CITY="Sfax"
ORG="Tesla Energie"
OU="IoT"

echo -e "${CYAN}ðŸ” Piston Control System Security Initialization${NC}"

################################################################################
# STEP 1: Generate Passwords and Secrets
################################################################################
POSTGRES_PASSWORD=$(openssl rand -hex 32)
JWT_SECRET=$(openssl rand -base64 96 | tr -d "=+/" | cut -c1-128)
JWT_ISSUER="piston-control"
JWT_AUDIENCE="piston-app"
REDIS_PASSWORD=$(openssl rand -hex 32)
SESSION_ENCRYPT_KEY=$(openssl rand -hex 16)
SESSION_SIGN_KEY=$(openssl rand -hex 32)
MQTT_PASSWORD=$(openssl rand -hex 32)
BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
VCS_REF=$(git rev-parse --short HEAD 2>/dev/null || echo "main")

################################################################################
# STEP 2: Create .env File (Docker-readable)
################################################################################
tee "${SCRIPT_DIR}/.env" > /dev/null <<EOF
POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
JWT_SECRET=${JWT_SECRET}
JWT_ISSUER=${JWT_ISSUER}
JWT_AUDIENCE=${JWT_AUDIENCE}
REDIS_PASSWORD=${REDIS_PASSWORD}
SESSION_ENCRYPT_KEY=${SESSION_ENCRYPT_KEY}
SESSION_SIGN_KEY=${SESSION_SIGN_KEY}
MQTT_PASSWORD=${MQTT_PASSWORD}
BUILD_DATE=${BUILD_DATE}
VCS_REF=${VCS_REF}
EOF
chmod 644 "${SCRIPT_DIR}/.env"

################################################################################
# STEP 3: Create certs directories and .gitkeep
################################################################################
CERTS_DIR="${SCRIPT_DIR}/certs"
NGINX_SSL_DIR="${SCRIPT_DIR}/nginx/ssl"
MOSQUITTO_CONFIG_DIR="${SCRIPT_DIR}/mosquitto/config"

mkdir -p "${CERTS_DIR}" "${NGINX_SSL_DIR}" "${MOSQUITTO_CONFIG_DIR}"

# Create .gitkeep files and make them Git-readable
for dir in "${CERTS_DIR}" "${NGINX_SSL_DIR}" "${MOSQUITTO_CONFIG_DIR}"; do
    touch "${dir}/.gitkeep"
    chown azureuser:azureuser "${dir}/.gitkeep"
    chmod 644 "${dir}/.gitkeep"
done

################################################################################
# STEP 4: Generate MQTT TLS Certificates (secure)
################################################################################
cd "${CERTS_DIR}"
CERT_DAYS=3650

# CA
openssl req -new -x509 -days ${CERT_DAYS} -extensions v3_ca \
    -keyout ca.key -out ca.crt \
    -subj "/C=${COUNTRY}/ST=${STATE}/L=${CITY}/O=${ORG}/OU=${OU}/CN=Piston-CA" \
    -nodes >/dev/null 2>&1
chmod 600 ca.key ca.crt

# Server certificate
openssl genrsa -out server.key 2048 >/dev/null 2>&1
openssl req -new -key server.key -out server.csr \
    -subj "/C=${COUNTRY}/ST=${STATE}/L=${CITY}/O=${ORG}/OU=${OU}/CN=mosquitto" >/dev/null 2>&1
openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key \
    -CAcreateserial -out server.crt -days ${CERT_DAYS} >/dev/null 2>&1
chmod 600 server.key server.crt
rm -f server.csr ca.srl

cd "${SCRIPT_DIR}"

################################################################################
# STEP 5: Generate Nginx SSL Certificates
################################################################################
cd "${NGINX_SSL_DIR}"
openssl req -x509 -nodes -days ${CERT_DAYS} -newkey rsa:4096 \
    -keyout key.pem -out cert.pem \
    -subj "/C=${COUNTRY}/ST=${STATE}/L=${CITY}/O=${ORG}/OU=${OU}/CN=localhost" >/dev/null 2>&1
chmod 600 key.pem cert.pem
cd "${SCRIPT_DIR}"

################################################################################
# STEP 6: MQTT password file
################################################################################
PASSWD_FILE="${MOSQUITTO_CONFIG_DIR}/passwd"
tee "${PASSWD_FILE}" > /dev/null <<EOF
# MQTT password file template
EOF
chmod 600 "${PASSWD_FILE}"

# Ensure mosquitto.conf is readable for Docker/git
if [ -f "${MOSQUITTO_CONFIG_DIR}/mosquitto.conf" ]; then
    chmod 644 "${MOSQUITTO_CONFIG_DIR}/mosquitto.conf"
fi

################################################################################
# STEP 7: Directory permissions
################################################################################
chmod 700 "${CERTS_DIR}" "${NGINX_SSL_DIR}" "${MOSQUITTO_CONFIG_DIR}"
chown -R azureuser:azureuser "${MOSQUITTO_CONFIG_DIR}" 2>/dev/null || true

################################################################################
# DONE
################################################################################
echo -e "${GREEN}âœ… Initialization Complete!${NC}"
echo -e "Generated files:"
echo -e "  â€¢ .env (644)"
echo -e "  â€¢ certs/*.key, *.crt (600)"
echo -e "  â€¢ nginx/ssl/*.pem (600)"
echo -e "  â€¢ mosquitto/config/passwd (600)"
echo -e "  â€¢ mosquitto/config/.gitkeep (644)"
